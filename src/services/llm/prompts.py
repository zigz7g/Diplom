# -*- coding: utf-8 -*-
from __future__ import annotations

from textwrap import dedent
from typing import Dict, Any


def build_annotation_prompt(ctx: Dict[str, Any], heur: Dict[str, Any]) -> str:
    """
    Формирует строгий промпт: запрещаем общий бла-бла и просим
    краткое, но предметное объяснение по конкретным строкам/переменным.
    """
    file = ctx.get("file", "-")
    line = ctx.get("line", 0)
    rule = ctx.get("rule_id", "")
    level = ctx.get("level", "info")
    message = ctx.get("message", "")
    snippet = ctx.get("snippet", "")
    file_text = ctx.get("file_text", "") or ""
    path_flags = ", ".join(heur.get("flags", [])) or "none"

    # Чтобы не передавать огромные файлы: обрезаем контекст (если заранее не обрезан)
    if len(file_text) > 4000:
        file_text = file_text[:4000] + "\n...\n"

    return dedent(f"""
    Ты — помощник по статическому анализу. Дай строгое JSON-решение по одному срабатыванию.
    Главная цель: лаконичный, ПРЕДМЕТНЫЙ комментарий, который опирается на реальный код.

    ДАНО:
    - Правило: {rule}
    - Уровень сканера: {level}
    - Файл: {file}
    - Строка: {line}
    - Сообщение сканера: {message}
    - Выдержка (snippet): |
      {snippet}

    КОНТЕКСТ ФАЙЛА (усечённо):
    --------------------------
    {file_text}

    ЭВРИСТИКА ПУТИ:
    - flags: {path_flags}

    ТРЕБОВАНИЯ К РЕШЕНИЮ:
    1) Верни чистый JSON (без ```), поля ровно:
       {{
         "status": "confirmed|false_positive",
         "severity": "critical|medium|low|info",
         "label": "короткий_ярлык",
         "confidence": 0.0-1.0,
         "comment": "2–6 предложений, строго по коду: укажи конкретные идентификаторы, поля, функции, место вставки/использования данных; если FP — укажи точную причину (например, каталог docs/tests/fixtures и почему из этого следует, что в проде не исполняется). Без общих фраз."
       }}
    2) Если путь явно не прод (docs/tests/examples/fixtures/locale) и фрагмент — пример/тест/локализация, ставь status="false_positive" и severity="info". Объясни, почему.
    3) Если подтверждаешь уязвимость — укажи точку входа данных (source), место использования/вставки (sink), экранирование/санитайзеры (если отсутствуют), краткий путь исполнения.
    4) Никаких отсылок к «у меня нет информации», никакого шаблонного текста. Комментарий обязан ссылаться на конкретные части фрагмента/контекста (имена переменных/параметров/полей/ключей).

    Возвращай только JSON по указанной схеме.
    """).strip()
